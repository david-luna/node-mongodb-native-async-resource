# MongoDB and async resource

The goal of this repository is to showcase an issue APM libraries (like elastic or opentelemetry)
are facing when instrumenting MongoDB commands and propose a solution.

## Requrements

To work with this repo you need
- NodeJS v18.16.0+
- Docker

## Cats Service

Our example is a simple API that stores and retrieves cats. It provides two paths:

- `/create`: creates a new Cat in MongoDB and returns it as JSON in the response.
- `/getAll`: uses a `find` cursor to retrieve all cats an return them as an JSON array.

Other paths will just get an empty response and no interaction with the database is made.

## The issue

APM libs like `elastic-apm-node` and `@opentlemetry/sdk-node` make use of APIs from
`async_hooks` NodeJS module to keep track of the context throughout all the callbacks or
async tasks performend for an incoming HTTP request. Since NodeJS v16.4.0 we have a stable
version of [AsyncLocalStorage API](https://nodejs.org/api/async_context.html#class-asynclocalstorage)
which is used to keep the context between callbacks/tasks pushed to the event loop.

The API mentioned above is aware of any async callback/tasks scheduled using native APIs
(setTimeout, setInterval, process.nextTick, Promises) but not if this scheduling is done by oneself.
One example is when you implement a `pool mechanism` to queue tasks that depends on a resource
being available and then execute all tasks at once. The follwing gist reveals this problem
https://gist.github.com/david-luna/8a66fc1308301f79af8bd2eb65bcbc07

MongoDB is using internally a pool mechanism (much more elaborate than the one in the gist) to
queue commands generated by cursors and other objects until a connection is available. When the
connection object is available then the pool is flushed by executing the callback of each
queued command.

## How to reproduce it

This repo comes with a set of `npm` scripts to ease the process of reproducing the issues. In
order to get a visual representation of the HTTP spans and its child MongoDB spans, follow the
steps below:

- Install dependencies

```bash
npm install
```

- Start a MongoDB instance in Docker

```bash
npm run mongodb:start
```

- Run the server with the selected APM setup

```bash
# $setup possible values are: otel, elastic
npm run server:$setup
```

- In a different terminal generate some traffic to the server

```bash
npm run XXXX
```


## The proposal
